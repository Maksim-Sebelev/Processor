#include <stdio.h>
#include <stdlib.h>
#include <assert.h>
#include <sys/stat.h>
#include <string.h>
#include "lib/lib.hpp"
#include "functions_for_files/files.hpp"

//------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

FILE* SafeFopen(const char* file, const char* modes)
{
    assert(modes);

    if (!file)
        EXIT(EXIT_FAILURE, "trying to open nullptr.");
    
    FILE* file_ptr = fopen(file, modes);

    if (!file_ptr)
        EXIT(EXIT_FAILURE, "failed open '%s' in mode '%s'\n", file, modes);

    return file_ptr;
}

//------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

size_t CalcFileLen(const char* file)
{
    assert(file);

    struct stat buffer = {};
    stat(file, &buffer);

    return (size_t) buffer.st_size;
}

//------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

char* ReadFileInBuffer(const char* file, size_t* len)
{
    assert(file);
    assert(len);

    size_t file_len = CalcFileLen(file      );
    FILE*  file_ptr = SafeFopen  (file, "rb");

    char* buffer = (char*) calloc(file_len + 1, sizeof(*buffer));

    if (!buffer)
        EXIT(EXIT_FAILURE, "failed open '%s' for reading.", file);

    buffer[file_len] = '\0';
        
    size_t fread_return = fread(buffer, sizeof(char), file_len, file_ptr);

    if (fread_return != file_len)
        EXIT(EXIT_FAILURE, "failed reading '%s'.", file);


    *len = file_len;

    return buffer;
}

//------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

void BufferDtor(const char* buffer)
{
    assert(buffer);
    
    FREE(buffer);

    return;
}

//------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

const char* GetFileExtension(const char* file_name)
{
    assert(file_name);

    const char* dot = strrchr(file_name, '.');

    if ((!dot) || (dot == file_name))
        return nullptr;

    return dot + 1;
}

//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
