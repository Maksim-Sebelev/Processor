#include <stdlib.h>
#include <unistd.h>
#include <getopt.h>
#include <assert.h>
#include "global/global_include.hpp"
#include "flags/flags.hpp"
#include "lib/lib.hpp"

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

static void HandleSrcFlag  (IOfile* files);
static void HandleBinFlag  (IOfile* files);
static void HandleUndefFlag(             );

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

static struct option long_options[] =
{
    {"src", required_argument, nullptr, 's'},
    {"exe", required_argument, nullptr, 'e'},
    {nullptr, 0, nullptr, 0}
};

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

IOfile CallFlags(int argc, char* argv[])
{
    assert(argv);

    if (argc <= 1)
        EXIT(EXIT_FAILURE, "asm:fatal err:empty input\n");

    IOfile files = {};
    int    opt   = 0;

    while ((opt = getopt_long(argc, argv, "s:e:", long_options, nullptr)) != -1)
    {
        switch (opt)
        {
            case 's': HandleSrcFlag  (&files); break;
            case 'e': HandleBinFlag  (&files); break;
            default : HandleUndefFlag(      ); break;
        }
    }

    return files;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

static void HandleSrcFlag(IOfile* files)
{
    assert(files);
    assert(optarg);

    files->asm_file = optarg;

    return;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

static void HandleBinFlag(IOfile* files)
{
    assert(files);
    assert(optarg);

    files->bin_file = optarg;

    return;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

__attribute__((__noreturn__)) static void HandleUndefFlag()
{
    if (optarg)
        EXIT(EXIT_FAILURE, "asm:fatal_err:undef_option - '%s'\n", optarg);

    exit(EXIT_FAILURE);
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
